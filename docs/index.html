<!DOCTYPE html><html lang="en"><head><title>OAuth.ee</title><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700&amp;subset=latin-ext,cyrillic-ext" rel="stylesheet" type="text/css"><link href="https://cdn.jsdelivr.net/gh/twbs/bootstrap@3/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css"><link href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v0/dist/bootstrap-toc.min.css" rel="stylesheet" type="text/css"><link href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9/build/styles/monokai-sublime.min.css" rel="stylesheet" type="text/css"><script defer data-domain="entu.dev" src="https://plausible.io/js/plausible.js"></script><style>body{padding-top:30px;padding-bottom:30px;font-family:'Helvetica Neue',Roboto,sans-serif;font-size:16px;font-weight:300;line-height:22px;color:#182530}h1{margin-top:120px;margin-bottom:110px;font-size:48px;font-weight:100;text-align:center}h2{margin-top:200px;margin-bottom:30px;padding-top:40px;font-size:32px;font-weight:100;text-align:center}h3{margin-top:120px;margin-bottom:10px;padding-top:40px;padding-bottom:5px;color:#23241f;font-weight:500;border-bottom:1px solid #e8e8e8}h4{margin-top:0;margin-bottom:10px;padding-top:40px;color:#23241f;font-weight:500}ul{margin-bottom:10px!important}pre{margin-top:10px;padding:0;border:none;border-radius:0;font-size:12px;line-height:16px}pre code{border-radius:5px}.hljs{padding:1em}</style></head><body data-spy="scroll" data-target="#toc"><div class="container-fluid"><div class="row"><div class="hidden-xs col-sm-2"><nav id="toc" data-spy="affix" data-toggle="toc"></nav></div><div class="col-xs-12 col-sm-8"><h1>OAuth.ee</h1><p>Use Estonian ID-card, Mobile-ID, Smart-ID or E-mail as OAuth authentication provider.</p><h2>Usage</h2><ol><li><p>Redirect user to one of the following url:</p><ul><li><a href="">/auth/id-card</a></li><li><a href="">/auth/mobile-id</a></li><li><a href="">/auth/smart-id</a></li><li><a href="">/auth/e-mail</a></li><li><a href="">/auth</a> - <em>will ask user the preferred auth method</em></li></ul><p>Required query parameters:</p><ul><li>response_type - <em>always equals to &quot;code&quot;</em></li><li>client_id</li><li>redirect_uri</li><li>scope - <em>always equals to &quot;openid&quot;</em></li><li>state</li></ul><p>Optional parameters - if not set, user must input required ones (depends of auth method):</p><ul><li>idc - <em>only for <a href="">/auth/mobile-id</a> and <a href="">/auth/smart-id</a></em></li><li>phone - <em>only for <a href="">/auth/mobile-id</a></em></li><li>email - <em>only for <a href="">/auth/e-mail</a></em></li><li>methods - <em>only for <a href="">/auth</a> - comma separated list of auth methods to show (id-card, mobile-id, smart-id, e-mail)</em></li></ul><pre><code class="language-bash">https://oauth.ee/auth/mobile-id?response_type=code&amp;client_id=QVnPZGdcXQ8Ev4mx&amp;redirect_uri=https://example.com/auth/callback&amp;scope=&amp;state=5600684163565994
</code></pre><p>After authentication user is redirected back to url set in <em>redirect_uri</em> parameter. Query parameter <em>code</em> contains the authorization code which Your service will exchange for an access token.</p><p>If the initial request contained a <em>state</em> parameter, the response also includes the exact value from the request. Your service must check if it matches one from initial request.</p></li><li><p>Make POST request to <a href="">/token</a> sending <em>client_id</em>, <em>client_secret</em>, <em>grant_type</em> and <em>code</em> (got from previous step). Parameter grant_type must always be &quot;authorization_code&quot;.</p><pre><code class="language-http">POST /token HTTP/1.1
Host: oauth.ee
Content-Type: application/json; charset=utf-8
Content-Length: 165

{
  &quot;client_id&quot;: &quot;QVnPZGdcXQ8Ev4mx&quot;,
  &quot;client_secret&quot;: &quot;aLs6BLQfhd3dX8rUDnvQzmhZcVMNPnwy&quot;,
  &quot;code&quot;: &quot;CYD9MDm8gY2F8EhV&quot;,
  &quot;grant_type&quot;: &quot;authorization_code&quot;
}
</code></pre><p>Response contains <em>access_token</em> what You need to get user information.</p><pre><code class="language-json">{
  &quot;access_token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9&quot;,
  &quot;expires_in&quot;: 3600,
  &quot;token_type&quot;: &quot;Bearer&quot;,
  &quot;state&quot;: &quot;5600684163565994&quot;
}
</code></pre></li><li><p>To get user information make GET request to <a href="">/user</a> with <em>access_token</em> (got from previous step) as query parameter or as Bearer authorization header (preferred!).</p><pre><code class="language-http">GET /user HTTP/1.1
Host: oauth.ee
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9
</code></pre><p>Response contains user information as JSON object.</p><pre><code class="language-json">{
  &quot;idcode&quot;: &quot;38001085718&quot;,
  &quot;firstname&quot;: &quot;JAAK-KRISTJAN&quot;,
  &quot;lastname&quot;: &quot;JÃ•EORG&quot;
}
</code></pre></li></ol><h2>Setup &amp; Run</h2><ol><li><p>Clone this repository and go to it's folder:</p><pre><code class="language-shell">git clone https://github.com/argoroots/est-o-auth.git ./est-o-auth
cd est-o-auth
</code></pre></li><li><p>Rename <em>env.example</em> to <em>.env</em>:</p><pre><code class="language-shell">cp .env.example .env
</code></pre></li><li><p>In <em>.env</em> file, set correct domains for authentication and id-card services (Nginx needs separate domain for ID-Card authentication); e-mail address (to get Let's Encrypt cert expiration notifications) and some random string for JWT token signing.</p><pre><code>DOMAIN=auth.example.com
IDCARD_DOMAIN=id.auth.example.com
EMAIL=auth@example.com
JWT_SECRET=Iel0jrC7fKFMjK2OBI4VYp2ygtrDQZBV
</code></pre></li><li><p>Generate HTTPS certificates:</p><pre><code class="language-shell">docker-compose --project-directory ./ -f ./docker-compose/certbot.yaml up --abort-on-container-exit
</code></pre></li><li><p>Renew HTTPS certificates - NB! run only when certificates are expiring and not on 1st setup:</p><pre><code class="language-shell">docker-compose --project-directory ./ -f ./docker-compose/certbot.yaml -f ./docker-compose/certbot-renew.yaml up --abort-on-container-exit
docker-compose --project-directory ./ -f ./docker-compose/auth.yaml restart nginx
</code></pre></li><li><p>Get ID-Card certificates:</p><pre><code class="language-shell">docker-compose --project-directory ./ -f ./docker-compose/id-card.yaml up
</code></pre></li><li><p>Start service:</p><pre><code class="language-shell">docker-compose --project-directory ./ -f ./docker-compose/auth.yaml up -d --build --remove-orphans
</code></pre></li></ol></div></div></div><script src="https://cdn.jsdelivr.net/gh/jquery/jquery@2/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/gh/twbs/bootstrap@3/dist/js/bootstrap.min.js"></script><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v0/dist/bootstrap-toc.min.js"></script><script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9/build/highlight.min.js"></script><script>hljs.initHighlightingOnLoad()</script></body></html>